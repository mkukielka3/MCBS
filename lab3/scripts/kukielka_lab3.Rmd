```{r global options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

# Lab 3: Homework Problems
Gosia Kukie≈Çka

### Dependencies
Load necessery libraries.

```{r load}
library(devtools)
library(Biobase)
library(ggplot2)
library(RColorBrewer)
library(gplots)
library(tidyverse)
library(data.table)
library(corpcor)
library(irlba)
library(Rtsne)
```

### Load data

```{r}

#con = url("http://bowtie-bio.sourceforge.net/recount/ExpressionSets/bottomly_eset.RData")
#load(file=con)
#close(con)
#save(bottomly.eset, file="../data/bottomly.Rdata")
load(file="../data/bottomly.Rdata")
```
### Prepare data
Log-transform, filter and center the data.
```{r}
edata <- as.matrix(exprs(bottomly.eset))
edata <- edata[rowMeans(edata) > 10, ]
edata <- log2(as.matrix(edata) + 1)

edata_scaled <- t(scale(t(edata), scale=FALSE, center=TRUE))
```
Perform singular value decomposition.
```{r}
svd.out <- svd(edata_scaled)
```
## Homework 1
Make one heatmap of the aforementioned Bottomly data with the following options: 
*a) both rows and columns are clustered, 
*b) show a dendrogram only on the columns., 
*c) scale in the column direction.

```{r}
my_palette <- colorRampPalette(c("blue", "white", "orange"))(n = 299)

png("../figures/kukielka_problem1.png",height=700,width=700)

heatmap.2(edata,
          main = "Bottomly et al. Clustered", # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          margins =c(12,9),     # widens margins around plot
          col=my_palette,       # use on color palette defined earlier 
          dendrogram="column",     # only draw a column dendrogram
          scale = "col",
          Colv = TRUE,
          Rowv = TRUE)

dev.off()
```
## Homework 2
Explore different combinations of PCs in scatter plots while coloring the data points by the genetic strains. 

```{r}
PC = data.table(svd.out$v,pData(bottomly.eset))

# "commented out" plot generator for all the combinations
if (FALSE) {
  cols <- names(PC)[0:21]
  for (i in 1:20) {
    for (j in (i+1):21) {
      #png(paste("../figures/kukielka_problem2_",".png", sep=paste(i,j,sep="_")),height=700,width=700)
      print(paste(cols[i], cols[j], sep="-"))
      ggplot(PC) + geom_point(aes_string(x=cols[i], y=cols[j], col="strain"))
      
      ggsave(paste("../figures/kukielka_problem2_",".png", sep=paste(i,j,sep="_")))
      #dev.off()
    }
  }
}
```
Scatterplot for the combination of PCs that separate the strains best.
```{r}
# Find a combination of PCs that separate the strains well. Send only one scatterplot.
ggplot(PC) + geom_point(aes(x=V2, y=V3, col=as.factor(strain))) #final
ggsave("../figures/kukielka_problem2.png")

```
## Homework 3
Make a scatter plot of the top 2 left singular vectors and save it to png file.

```{r}
png("../figures/kukielka_problem3.png",height=700,width=1400)

par(mfrow=c(1,2))
plot(1:nrow(edata), svd.out$u[,1],pch=20)
plot(1:nrow(edata), svd.out$u[,2],pch=20)

dev.off()
```
## Homework 4
Make one figure that contains violin plots of the top 5 left singular vectors (loadings).
```{r}
dt = data.table(svd.out$u[,1:5])

top5 <- gather(dt, singular_vector, value)

ggplot(top5)+ geom_violin(aes(x=as.factor(singular_vector), y=value),draw_quantiles = c(0.25, 0.5, 0.75)) + geom_jitter(aes(x=as.factor(singular_vector), y=value), alpha=0.5)
ggsave("../figures/kukielka_problem4.png")
```
## Homework 5
Cluster the genes (rows) using K-means clustering (function `kmeans()`) on the original data,  with `k=5` clusters. 
```{r}
kmeans_clust <- kmeans(edata, 5)
clusters <- as.factor(kmeans_clust$cluster)
```
Create a 2-dimensional t-SNE projection.
```{r}
set.seed(1)

tsne_out <- Rtsne(edata, pca=TRUE, perplexity=30)
tsne = data.table(tsne_out$Y)
```
Visualize t-SNE projection data coloring points by clusters.
```{r}
ggplot(tsne) + geom_point(aes(x=V1, y=V2, col=clusters))
ggsave("../figures/kukielka_problem5.png")
```
